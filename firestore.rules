rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // MARK: - Helper Functions
    /// Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /// Check if user is admin or superAdmin
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin');
    }
    
    /// Check if user is superAdmin only
    function isSuperAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin';
    }
    
    /// Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // MARK: - Users Collection
    /// Users collection - read own, admin write, public create (for sign-up)
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      // Allow users to create their own user document during sign-up
      allow create: if isAuthenticated() && isOwner(userId);
      // Allow users to update their own email (if needed)
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // MARK: - Services Collection
    /// Services - public read, admin write
    match /services/{serviceId} {
      allow read: if true; // Public read for booking
      allow create, update, delete: if isAdmin();
    }
    
    // MARK: - Appointments Collection
    /// Appointments - public create and read (for booking and availability)
    /// Public read required so unauthenticated guests can check availability (overlap check).
    /// Personal information must not be displayed to other clients in app code.
    match /appointments/{appointmentId} {
      // Allow public to create appointments (for booking)
      allow create: if true;
      
      // Allow public read so availability check works for guest and signed-in clients.
      // App only uses appointment times for overlap; no other client PII is shown.
      allow read: if true;
      
      // Only admin can update/delete appointments
      allow update, delete: if isAdmin();
    }
    
    // MARK: - Clients Collection
    /// Clients - admin read/write, clients can read their own record
    match /clients/{clientId} {
      // Allow clients to read their own client record (matched by email)
      allow read: if isAdmin() || 
        (isAuthenticated() && 
         resource.data.email == request.auth.token.email);
      // Only admin can write
      allow write: if isAdmin();
    }
    
    // MARK: - Business Settings Collection
    /// Business settings - public read, admin write
    match /business_settings/{settingsId} {
      allow read: if true; // Public read for booking page
      allow write: if isAdmin();
    }
    
    // MARK: - Payments Collection
    /// Payments - admin only
    match /payments/{paymentId} {
      allow read, write: if isAdmin();
    }
    
    // MARK: - Availability Collection
    /// Availability - public read, admin write
    match /availability/{availabilityId} {
      allow read: if true; // Public read for booking
      allow write: if isAdmin();
    }
    
    // MARK: - App Version Collection
    /// App version - public read, admin write
    /// Used for version forcing and update checks
    match /app_version/{versionId} {
      allow read: if true; // Public read for version checking
      allow write: if isAdmin();
    }
    
    // MARK: - Service Categories Collection
    /// Service categories - public read, admin write
    /// Categories are used to organize services and should be visible to clients for booking
    match /serviceCategories/{categoryId} {
      allow read: if true; // Public read for booking
      allow create, update, delete: if isAdmin();
    }
    
    // MARK: - Notifications Collection
    /// Notifications - admin only read, system write
    /// Notifications track appointment events for admin visibility
    match /notifications/{notificationId} {
      allow read: if isAdmin();
      // Only allow system to create notifications (via Cloud Functions or backend)
      // For now, allow authenticated users to create (will be restricted later)
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // MARK: - Software Enhancements Collection
    /// Software enhancements - super admin only
    /// Super admins can create, read, update, and delete software enhancements
    /// (bugs, features, suggestions, improvements)
    match /software_enhancements/{enhancementId} {
      allow read, write: if isSuperAdmin();
    }
    
    // MARK: - Time-Off Collection
    /// Time-off - public read so guests can check availability when booking
    /// Admin and super admin can manage time-off periods
    match /time_off/{timeOffId} {
      // Public read for booking availability (guests are unauthenticated)
      allow read: if true;
      // Only admin and super admin can create, update, and delete
      allow create, update, delete: if isAdmin();
    }
  }
}
