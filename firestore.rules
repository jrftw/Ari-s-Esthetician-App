rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // MARK: - Helper Functions
    /// Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /// Check if user is admin or superAdmin
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin');
    }
    
    /// Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // MARK: - Users Collection
    /// Users collection - read own, admin write, public create (for sign-up)
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      // Allow users to create their own user document during sign-up
      allow create: if isAuthenticated() && isOwner(userId);
      // Allow users to update their own email (if needed)
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // MARK: - Services Collection
    /// Services - public read, admin write
    match /services/{serviceId} {
      allow read: if true; // Public read for booking
      allow create, update, delete: if isAdmin();
    }
    
    // MARK: - Appointments Collection
    /// Appointments - public create, admin read/write, own read, recent read for confirmation
    match /appointments/{appointmentId} {
      // Allow public to create appointments (for booking)
      allow create: if true;
      
      // Allow reading appointments if:
      // 1. User is admin
      // 2. User is authenticated and email matches
      // 3. Appointment was created recently (within 1 hour) - for guest confirmation screen
      allow read: if isAdmin() || 
        (isAuthenticated() && 
         resource.data.clientEmail == request.auth.token.email) ||
        (resource.data.createdAt != null &&
         resource.data.createdAt > request.time - duration.value(1, 'h'));
      
      // Only admin can update/delete appointments
      allow update, delete: if isAdmin();
    }
    
    // MARK: - Clients Collection
    /// Clients - admin only
    match /clients/{clientId} {
      allow read, write: if isAdmin();
    }
    
    // MARK: - Business Settings Collection
    /// Business settings - public read, admin write
    match /business_settings/{settingsId} {
      allow read: if true; // Public read for booking page
      allow write: if isAdmin();
    }
    
    // MARK: - Payments Collection
    /// Payments - admin only
    match /payments/{paymentId} {
      allow read, write: if isAdmin();
    }
    
    // MARK: - Availability Collection
    /// Availability - public read, admin write
    match /availability/{availabilityId} {
      allow read: if true; // Public read for booking
      allow write: if isAdmin();
    }
  }
}
